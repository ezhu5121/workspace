_hdrs = [
"include/dpdk/cmdline_socket.h",
"include/dpdk/rte_port_ras.h",
"include/dpdk/rte_dpaa2_mempool.h",
"include/dpdk/cmdline_rdline.h",
"include/dpdk/rte_uuid.h",
"include/dpdk/rte_gre.h",
"include/dpdk/rte_meter.h",
"include/dpdk/rte_per_lcore.h",
"include/dpdk/rte_cycles.h",
"include/dpdk/rte_branch_prediction.h",
"include/dpdk/rte_gro.h",
"include/dpdk/rte_ip.h",
"include/dpdk/rte_test.h",
"include/dpdk/rte_version.h",
"include/dpdk/rte_red.h",
"include/dpdk/rte_lpm.h",
"include/dpdk/rte_table_stub.h",
"include/dpdk/rte_table_lpm_ipv6.h",
"include/dpdk/rte_latencystats.h",
"include/dpdk/rte_port_ring.h",
"include/dpdk/rte_cryptodev_scheduler.h",
"include/dpdk/rte_atomic_64.h",
"include/dpdk/rte_pdump.h",
"include/dpdk/rte_dev.h",
"include/dpdk/rte_table_hash.h",
"include/dpdk/rte_eal.h",
"include/dpdk/rte_byteorder_32.h",
"include/dpdk/rte_class.h",
"include/dpdk/rte_bus_vmbus.h",
"include/dpdk/rte_bus.h",
"include/dpdk/rte_vhost.h",
"include/dpdk/rte_vhost_crypto.h",
"include/dpdk/rte_sched.h",
"include/dpdk/rte_avp_fifo.h",
"include/dpdk/rte_compressdev_pmd.h",
"include/dpdk/rte_event_ring.h",
"include/dpdk/rte_pmd_i40e.h",
"include/dpdk/rte_cryptodev_scheduler_operations.h",
"include/dpdk/rte_pause.h",
"include/dpdk/rte_crypto.h",
"include/dpdk/rte_config.h",
"include/dpdk/rte_atomic_32.h",
"include/dpdk/rte_crypto_asym.h",
"include/dpdk/rte_vfio.h",
"include/dpdk/rte_eventdev_pmd_pci.h",
"include/dpdk/rte_lpm6.h",
"include/dpdk/rte_alarm.h",
"include/dpdk/cmdline_parse.h",
"include/dpdk/rte_comp.h",
"include/dpdk/rte_service_component.h",
"include/dpdk/rte_hypervisor.h",
"include/dpdk/rte_port_kni.h",
"include/dpdk/rte_jhash.h",
"include/dpdk/rte_bitmap.h",
"include/dpdk/rte_crypto_sym.h",
"include/dpdk/rte_thash.h",
"include/dpdk/rte_event_timer_adapter_pmd.h",
"include/dpdk/rte_lru_x86.h",
"include/dpdk/generic/rte_cycles.h",
"include/dpdk/generic/rte_pause.h",
"include/dpdk/generic/rte_memcpy.h",
"include/dpdk/generic/rte_byteorder.h",
"include/dpdk/generic/rte_vect.h",
"include/dpdk/generic/rte_io.h",
"include/dpdk/generic/rte_prefetch.h",
"include/dpdk/generic/rte_spinlock.h",
"include/dpdk/generic/rte_rwlock.h",
"include/dpdk/generic/rte_cpuflags.h",
"include/dpdk/generic/rte_atomic.h",
"include/dpdk/rte_acl_osdep.h",
"include/dpdk/rte_ethdev_driver.h",
"include/dpdk/rte_approx.h",
"include/dpdk/rte_net_crc.h",
"include/dpdk/cmdline_vt100.h",
"include/dpdk/rte_hash_crc.h",
"include/dpdk/rte_ring.h",
"include/dpdk/rte_memcpy.h",
"include/dpdk/rte_tcp.h",
"include/dpdk/cmdline_parse_num.h",
"include/dpdk/rte_eventdev_pmd_vdev.h",
"include/dpdk/rte_acl.h",
"include/dpdk/rte_lpm_sse.h",
"include/dpdk/rte_ip_frag.h",
"include/dpdk/rte_compat.h",
"include/dpdk/rte_errno.h",
"include/dpdk/rte_common.h",
"include/dpdk/rte_pmd_bnxt.h",
"include/dpdk/rte_random.h",
"include/dpdk/rte_port_sched.h",
"include/dpdk/rte_byteorder.h",
"include/dpdk/cmdline_cirbuf.h",
"include/dpdk/rte_event_timer_adapter.h",
"include/dpdk/rte_vect.h",
"include/dpdk/rte_eth_bond_8023ad.h",
"include/dpdk/rte_timer.h",
"include/dpdk/rte_hash.h",
"include/dpdk/rte_eth_softnic.h",
"include/dpdk/rte_table.h",
"include/dpdk/rte_event_crypto_adapter.h",
"include/dpdk/rte_arp.h",
"include/dpdk/rte_vdpa.h",
"include/dpdk/rte_table_acl.h",
"include/dpdk/rte_rtm.h",
"include/dpdk/cmdline_parse_string.h",
"include/dpdk/rte_bus_pci.h",
"include/dpdk/rte_bbdev_op.h",
"include/dpdk/rte_memory.h",
"include/dpdk/rte_pci_dev_feature_defs.h",
"include/dpdk/rte_flow_classify.h",
"include/dpdk/rte_io.h",
"include/dpdk/rte_rawdev.h",
"include/dpdk/rte_distributor.h",
"include/dpdk/rte_tailq.h",
"include/dpdk/rte_port_fd.h",
"include/dpdk/rte_bus_ifpga.h",
"include/dpdk/rte_mtr.h",
"include/dpdk/cmdline.h",
"include/dpdk/rte_prefetch.h",
"include/dpdk/rte_malloc_heap.h",
"include/dpdk/rte_port_frag.h",
"include/dpdk/rte_mbuf_pool_ops.h",
"include/dpdk/bpf_def.h",
"include/dpdk/rte_tm.h",
"include/dpdk/cmdline_parse_etheraddr.h",
"include/dpdk/rte_spinlock.h",
"include/dpdk/cmdline_parse_portlist.h",
"include/dpdk/rte_ring_generic.h",
"include/dpdk/rte_compressdev.h",
"include/dpdk/rte_efd.h",
"include/dpdk/rte_flow_driver.h",
"include/dpdk/rte_lru.h",
"include/dpdk/rte_byteorder_64.h",
"include/dpdk/rte_eth_vhost.h",
"include/dpdk/rte_table_lpm.h",
"include/dpdk/rte_memzone.h",
"include/dpdk/rte_eth_ring.h",
"include/dpdk/rte_event_eth_rx_adapter.h",
"include/dpdk/rte_eventdev_pmd.h",
"include/dpdk/rte_sched_common.h",
"include/dpdk/rte_net.h",
"include/dpdk/rte_member.h",
"include/dpdk/rte_ring_c11_mem.h",
"include/dpdk/rte_eth_ctrl.h",
"include/dpdk/exec-env/rte_kni_common.h",
"include/dpdk/rte_eal_interrupts.h",
"include/dpdk/rte_eal_memconfig.h",
"include/dpdk/rte_time.h",
"include/dpdk/rte_reorder.h",
"include/dpdk/rte_kvargs.h",
"include/dpdk/rte_bpf.h",
"include/dpdk/rte_security_driver.h",
"include/dpdk/rte_rawdev_pmd.h",
"include/dpdk/rte_table_hash_cuckoo.h",
"include/dpdk/rte_power.h",
"include/dpdk/rte_cryptodev.h",
"include/dpdk/rte_mbuf.h",
"include/dpdk/rte_gso.h",
"include/dpdk/rte_string_fns.h",
"include/dpdk/rte_launch.h",
"include/dpdk/rte_vmbus_reg.h",
"include/dpdk/rte_tm_driver.h",
"include/dpdk/rte_log.h",
"include/dpdk/rte_dev_info.h",
"include/dpdk/rte_bpf_ethdev.h",
"include/dpdk/rte_eventdev.h",
"include/dpdk/rte_port_source_sink.h",
"include/dpdk/rte_avp_common.h",
"include/dpdk/rte_interrupts.h",
"include/dpdk/rte_icmp.h",
"include/dpdk/rte_pmd_ixgbe.h",
"include/dpdk/rte_bbdev.h",
"include/dpdk/cmdline_parse_ipaddr.h",
"include/dpdk/rte_malloc.h",
"include/dpdk/rte_lcore.h",
"include/dpdk/rte_devargs.h",
"include/dpdk/rte_compressdev_internal.h",
"include/dpdk/rte_mempool.h",
"include/dpdk/rte_eth_bond.h",
"include/dpdk/rte_jobstats.h",
"include/dpdk/rte_table_action.h",
"include/dpdk/rte_pci.h",
"include/dpdk/rte_rwlock.h",
"include/dpdk/rte_pipeline.h",
"include/dpdk/rte_service.h",
"include/dpdk/rte_pmd_dpaa.h",
"include/dpdk/rte_keepalive.h",
"include/dpdk/rte_ethdev.h",
"include/dpdk/rte_bitrate.h",
"include/dpdk/rte_fbarray.h",
"include/dpdk/rte_ether.h",
"include/dpdk/rte_reciprocal.h",
"include/dpdk/rte_security.h",
"include/dpdk/rte_pmd_dpaa2_qdma.h",
"include/dpdk/rte_port.h",
"include/dpdk/rte_ethdev_pci.h",
"include/dpdk/rte_metrics.h",
"include/dpdk/rte_esp.h",
"include/dpdk/rte_bbdev_pmd.h",
"include/dpdk/rte_hexdump.h",
"include/dpdk/rte_table_array.h",
"include/dpdk/rte_cpuflags.h",
"include/dpdk/rte_ethdev_vdev.h",
"include/dpdk/rte_atomic.h",
"include/dpdk/rte_ethdev_core.h",
"include/dpdk/rte_debug.h",
"include/dpdk/rte_cfgfile.h",
"include/dpdk/rte_mtr_driver.h",
"include/dpdk/rte_udp.h",
"include/dpdk/rte_pmd_dpaa2_cmdif.h",
"include/dpdk/rte_port_in_action.h",
"include/dpdk/rte_sctp.h",
"include/dpdk/rte_port_ethdev.h",
"include/dpdk/rte_cryptodev_pmd.h",
"include/dpdk/rte_bus_vdev.h",
"include/dpdk/rte_pci_dev_features.h",
"include/dpdk/rte_kni.h",
"include/dpdk/rte_mbuf_ptype.h",
"include/dpdk/rte_fbk_hash.h",
"include/dpdk/rte_flow.h",
]
_libs = [
"lib/librte_metrics.a",
"lib/librte_eventdev.a",
"lib/librte_pmd_enic.a",
"lib/librte_acl.a",
"lib/librte_meter.a",
"lib/librte_pmd_dpaa_event.a",
"lib/librte_pmd_ixgbe.a",
"lib/librte_mempool_octeontx.a",
"lib/librte_pmd_vhost.a",
"lib/librte_bus_vdev.a",
"lib/librte_pmd_kni.a",
"lib/librte_jobstats.a",
"lib/librte_pmd_dpaa2_qdma.a",
"lib/librte_pmd_qat.a",
"lib/librte_mempool_stack.a",
"lib/librte_pmd_dpaa.a",
"lib/librte_pmd_null_crypto.a",
"lib/librte_pmd_virtio.a",
"lib/librte_pmd_crypto_scheduler.a",
"lib/librte_pmd_i40e.a",
"lib/librte_pmd_qede.a",
"lib/librte_kvargs.a",
"lib/librte_cryptodev.a",
"lib/librte_mbuf.a",
"lib/librte_net.a",
"lib/librte_pmd_vmxnet3_uio.a",
"lib/librte_distributor.a",
"lib/librte_pmd_avf.a",
"lib/librte_timer.a",
"lib/librte_power.a",
"lib/librte_gro.a",
"lib/librte_pdump.a",
"lib/librte_pmd_vdev_netvsc.a",
"lib/librte_table.a",
"lib/librte_pipeline.a",
"lib/librte_port.a",
"lib/librte_pmd_avp.a",
"lib/librte_ring.a",
"lib/librte_rawdev.a",
"lib/librte_pmd_null.a",
"lib/librte_member.a",
"lib/libdpdk.a",
"lib/librte_bus_pci.a",
"lib/librte_pmd_ring.a",
"lib/librte_ip_frag.a",
"lib/librte_pmd_thunderx_nicvf.a",
"lib/librte_pmd_sw_event.a",
"lib/librte_pmd_bbdev_null.a",
"lib/librte_pmd_skeleton_rawdev.a",
"lib/librte_ethdev.a",
"lib/librte_pmd_tap.a",
"lib/librte_flow_classify.a",
"lib/librte_pmd_dpaa2_event.a",
"lib/librte_pmd_dpaa_sec.a",
"lib/librte_pmd_sfc_efx.a",
"lib/librte_latencystats.a",
"lib/librte_bbdev.a",
"lib/librte_bus_vmbus.a",
"lib/librte_mempool_ring.a",
"lib/librte_cmdline.a",
"lib/librte_pmd_fm10k.a",
"lib/librte_cfgfile.a",
"lib/librte_sched.a",
"lib/librte_reorder.a",
"lib/librte_pmd_failsafe.a",
"lib/librte_eal.a",
"lib/librte_mempool_dpaa2.a",
"lib/librte_kni.a",
"lib/librte_bus_dpaa.a",
"lib/librte_pmd_axgbe.a",
"lib/librte_pmd_softnic.a",
"lib/librte_pmd_ena.a",
"lib/librte_bus_fslmc.a",
"lib/librte_common_octeontx.a",
"lib/librte_pmd_af_packet.a",
"lib/librte_compressdev.a",
"lib/librte_pmd_octeontx.a",
"lib/librte_bus_ifpga.a",
"lib/librte_pmd_bond.a",
"lib/librte_lpm.a",
"lib/librte_pmd_dpaa2_cmdif.a",
"lib/librte_mempool.a",
"lib/librte_bpf.a",
"lib/librte_hash.a",
"lib/librte_mempool_dpaa.a",
"lib/librte_efd.a",
"lib/librte_vhost.a",
"lib/librte_pmd_ifc.a",
"lib/librte_pmd_ifpga_rawdev.a",
"lib/librte_pmd_ark.a",
"lib/librte_pmd_netvsc.a",
"lib/librte_pmd_e1000.a",
"lib/librte_pmd_opdl_event.a",
"lib/librte_pmd_virtio_crypto.a",
"lib/librte_pmd_octeontx_ssovf.a",
"lib/librte_pmd_lio.a",
"lib/librte_pmd_dpaa2.a",
"lib/librte_pmd_octeontx_zip.a",
"lib/librte_pmd_nfp.a",
"lib/librte_pci.a",
"lib/librte_pmd_cxgbe.a",
"lib/librte_gso.a",
"lib/librte_bitratestats.a",
"lib/librte_pmd_dpaa2_sec.a",
"lib/librte_pmd_skeleton_event.a",
"lib/librte_pmd_bnxt.a",
"lib/librte_security.a",
"lib/librte_mempool_bucket.a",
]
_modules = ["igb_uio.ko", "rte_kni.ko",]
filegroup(
    name = "dpdk-libs",
    srcs = _libs,
    visibility = ["//visibility:private"],
)
filegroup(
    name = "dpdk-hdrs",
    srcs = _hdrs,
    visibility = ["//visibility:private"],
)
filegroup(
    name = "dpdk-modules",
    srcs = _modules,
    visibility = ["//visibility:private"],
)
cc_library(
    name = "libs",
    srcs = [":dpdk-libs"],
    hdrs = [":dpdk-hdrs"],
    includes = ["include", "include/dpdk"],
    deps = ["@numactl//:libnuma"],
    linkstatic = 1,
    copts=["-fPIC"],
    linkopts = ["-lnuma"],
    visibility = ["//visibility:public"],
)
cc_binary(
    name = "igb_uio",
    srcs = ["igb_uio.ko"],
    deps = [":libs", "@libelf//:libelf"],
    visibility = ["//visibility:public"],
)
cc_binary(
    name = "rte_kni",
    srcs = ["rte_kni.ko", "@libelf//:libelf"],
    deps = [":libs"],
    visibility = ["//visibility:public"],
)
cc_binary(
    name = "pdump",
    srcs = ["dpdk-pdump"],
    deps = [":libs"],
    visibility = ["//visibility:public"],
)
cc_binary(
    name = "procinfo",
    srcs = ["dpdk-procinfo"],
    deps = [":libs"],
    visibility = ["//visibility:public"],
)
cc_binary(
    name = "devbind",
    srcs = ["dpdk-devbind"],
    deps = [":libs"],
    visibility = ["//visibility:public"],
)
filegroup(
    name = "makefile",
    srcs = ["GNUmakefile"],
    visibility = ["//visibility:private"],
)

# TODO: select arch and toolchain
# TODO: install deps: linux kernel, libelf
genrule(
    name = "dpdk-build",
    srcs = [":makefile"],
    outs = _hdrs + _libs + 
            ["dpdk-procinfo", "dpdk-devbind", "dpdk-pdump", "igb_uio.ko", "rte_kni.ko"],
    local = 1,
    cmd = """
    SRCROOT=$$(dirname $(location :makefile))
    pushd $$SRCROOT
        make config EXTRA_CFLAGS="-fPIC" T=x86_64-native-linuxapp-clang
        make T=x86_64-native-linuxapp-clang EXTRA_CFLAGS="-fPIC"\
         DESTDIR=tmp install 
    popd
    echo "$$(dirname $(location include/dpdk/rte_config.h))"
    cp -rv $$SRCROOT/tmp/include/dpdk/* $$(dirname $(location include/dpdk/rte_config.h))/
    cp -rv $$SRCROOT/tmp/lib/* $$(dirname $(location lib/libdpdk.a))/
    cp -v $$SRCROOT/tmp/bin/dpdk-pdump $(location dpdk-pdump)
    cp -v $$SRCROOT/tmp/bin/dpdk-procinfo $(location dpdk-procinfo)
    cp -v $$SRCROOT/tmp/sbin/dpdk-devbind $(location dpdk-devbind)
    cp -v $$SRCROOT/tmp/lib/modules/4.15.0-32-generic/extra/dpdk/igb_uio.ko \
            $(location igb_uio.ko)
    cp -v $$SRCROOT/tmp/lib/modules/4.15.0-32-generic/extra/dpdk/rte_kni.ko \
            $(location rte_kni.ko)

""",
    visibility = ["//visibility:private"],
)
